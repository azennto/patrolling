# Maze Patrolling / Maze Experimentation Repository


## ディレクトリおよび主要ファイルの意味

### exp_data ディレクトリ

実験やゲームプレイ中に生成された各種データを保存するためのディレクトリです。以下のサブディレクトリに分かれています。

- **exp_data/maze/**  
  ゲームやシミュレーションで使用・生成された迷路のファイルが保存されています。  
  （例：`generated_maze.txt` や `generated_maze_1.txt` など、ランダムに生成された迷路パターンが記録されています）

- **exp_data/move_history/**  
  ゲームプレイやシミュレーション中に記録された移動履歴のログファイルが格納されています。  
  各ファイルには、プレイヤーの移動方向とタイムスタンプが記録され、リプレイ機能や後日の解析に利用されます。

- **exp_data/reasons/**  
  リプレイ再生中にユーザが入力した操作の理由や説明が記録されるログファイルが保存されています。  
  これらのファイルには、各移動に対するユーザの操作理由と、その時の座標情報などのメタデータが含まれています。

---

### src ディレクトリ

プロジェクトの主要なソースコードが格納されているディレクトリです。各モジュールは、迷路の自動巡回、ゲームプレイ、リプレイ、統計解析など、目的ごとに機能が分かれています。

- **src/__init__.py**  
  パッケージの初期化用ファイルで、簡単なテスト関数などが定義されています。

- **src/agent.py**  
  迷路ファイル、意思決定ポイント、スタート／ゴール座標を入力として受け取り、エージェントが迷路内を自動巡回するシミュレーションを実行するプログラムです。

- **src/exp/**  
  実験や解析用のスクリプトがまとめられたサブディレクトリです。  
  - **maze_experiment.py**  
    ゲームプレイとリプレイを統合し、実験全体の流れを管理するスクリプトです。  
  - **maze_game.py**  
    Pygame を用いたインタラクティブな迷路ゲームの実装が含まれています。  
  - **maze_replay.py**  
    保存された移動履歴をもとに、リプレイ再生とユーザによる操作理由の入力を行うスクリプトです。

- **src/game.py**  
  シンプルに実行可能な迷路ゲームの実装です。  
  （`maze_game.py` と類似の機能を提供し、単体でのゲームプレイが可能です）

- **src/hist_maze_road.py**  
  複数のランダム迷路を生成し、各迷路における「見かけ上の道の本数」をカウント・統計解析するためのツールです。

- **src/hist_think_time.py**  
  移動履歴ファイルから各移動間のタイムスタンプ差（＝思考時間）を抽出し、ヒストグラムおよび累積グラフを描画する解析ツールです。

- **src/replay.py**  
  保存された移動履歴を読み込み、迷路内でのプレイヤーの動きを再現するシンプルなリプレイスクリプトです。  
  ユーザがスペースキーで一時停止できる機能など、インタラクティブな再生機能が実装されています。


---

## 各モジュールの概要

### 1. `agent.py`
- **概要**:  
  迷路ファイルと意思決定ポイント、スタート／ゴール座標を入力として受け取り、エージェントが迷路内を巡回するシミュレーションを行うプログラムです。

- **主な機能**:  
  - **意思決定ポイントの指定**  
    - 実験データファイル（各ブロック内に `"Coordinates: (x,y)"` が記載された形式）または  
    - セミコロン区切りの座標リスト（例："2,3; 5,6; 7,4"）から抽出
  - **移動ルール**  
    1. 現在位置から各意思決定ポイントまでのマンハッタン距離を算出し、最短候補群を抽出  
    2. ダイクストラ法による重み付き最短路の総移動コストで評価し、さらに未探索マスの有無で優先順位を決定  
    3. 選択したポイントへは、算出された経路に沿って移動（各マス移動はシミュレーション上で一定時間消費）
  - **移動履歴の記録**  
    各移動の方向とタイムスタンプを記録し、シミュレーション終了後にファイルへ出力します。

- **利用方法**:  
  ターミナルから実行すると、迷路ファイルのパス、意思決定ポイント（ファイルまたは手入力）、スタート・ゴール座標を順次入力するプロンプトが表示され、シミュレーションが開始されます。  
  最終的に移動履歴（例：`agent_move_history.txt`）が出力されます。

---

### 2. `exp/maze_experiment.py`
- **概要**:  
  実験全体の流れを統括するスクリプトです。

- **主な処理内容**:
  1. **迷路ゲームのプレイ**  
     - コマンドライン引数で迷路ファイルが指定されればそれを使用し、なければランダム生成された迷路でプレイ（内部で `maze_game.py` を呼び出します）  
     - ゲーム終了時に移動履歴が保存されます（例：`exp_data/move_history` フォルダ内）
  2. **最新の移動履歴ファイルの選定**  
     - 保存ディレクトリから最新の移動履歴ファイルを自動で取得
  3. **リプレイの実行**  
     - 選択した移動履歴を元にリプレイを再生  
     - 待機時間が 0.5 秒以上の場合は、Tkinter の入力ウィンドウでユーザに操作内容とその理由を入力してもらい、メタデータとして記録

---

### 3. `exp/maze_game.py`
- **概要**:  
  Pygame を用いたインタラクティブな迷路ゲームです。

- **主な機能**:  
  - **迷路の読み込みまたは生成**  
    - 指定された迷路ファイルが存在しない場合は、ランダムな迷路を生成して保存します
  - **スタート地点の設定**  
    - 迷路内の数字セルのうち `'5'` をスタート地点として設定
  - **プレイヤー移動**  
    - キーボードの矢印キーによる移動で、各移動ごとにタイムスタンプ付きの移動履歴が記録され、移動コストが加算されます
  - **探索済みセルの管理と描画**  
    - 現在位置から上下左右に連続する通路を「探索済み」として記録し、色分けして表示します
  - **移動履歴の保存**  
    - 移動間隔が 500ms 以上の場合は、コメント（# カウント付き）を履歴に追加して保存

---

### 4. `exp/maze_replay.py`
- **概要**:  
  迷路ゲームの移動履歴ファイルを元に、リプレイ再生を行うスクリプトです。

- **主な機能**:  
  - 迷路と移動履歴ファイルを読み込み、リプレイデータを解析  
  - 待機時間が 0.5 秒以上の場合、Tkinter を用いてユーザに操作内容と理由の入力を求め、入力情報と座標情報を含むメタデータを記録  
  - 再生中に現在の移動コストを画面下部に表示し、リプレイ再生を行います

---

### 5. `game.py`
- **概要**:  
  `exp/maze_game.py` と同様に、Pygame を用いた迷路ゲームですが、単体で実行可能な形式です。

- **特徴**:  
  - 迷路の読み込み／生成、プレイヤー移動、探索済みセルの管理、移動履歴の記録・保存など基本機能を実装  
  - ゲーム終了条件（スタート地点に戻り、全ての数字セルを探索済みにする）を満たすと、移動履歴が保存されて終了します

---

### 6. `hist_maze_road.py`
- **概要**:  
  複数のランダム迷路を生成し、各迷路における「見かけ上の道の本数」をカウント・統計解析するスクリプトです。

- **主な機能**:  
  - 指定回数（例：10,000回）の迷路生成と、各迷路内の連続した数字セル（通路）の数のカウント  
  - カウント結果の分布（ヒストグラム）のプロット  
  - 四分位数（Q1, Median, Q3）に該当する迷路の一部を選択して保存（`quartile_mazes` ディレクトリへ出力）

---

### 7. `hist_think_time.py`
- **概要**:  
  移動履歴ファイル（または複数ファイル）から各移動間のタイムスタンプ差（＝思考時間）を抽出し、ヒストグラムおよび累積時間グラフをプロットする解析ツールです。

- **主な機能**:  
  - 単一ファイルまたはディレクトリ内の複数ファイルを対象に、移動ごとの思考時間（秒単位）を算出  
  - 思考時間のヒストグラムと、経過時間に対する累積思考時間の折れ線グラフを描画し、各ファイルごとに色分けして比較可能

---

### 8. `replay.py`
- **概要**:  
  移動履歴ファイルを読み込み、迷路の再生を行うシンプルなリプレイスクリプトです。

- **主な機能**:  
  - 迷路と履歴ファイルから開始時刻および各移動のタイムスタンプを取得  
  - Pygame 上で、待機時間を反映しながらプレイヤー移動と探索済み領域の描画を行います  
  - 現在の総移動コストを画面下部に表示し、スペースキーで一時停止が可能なインタラクティブな再生機能を備えています

---

## 使用方法（例）

- **迷路エージェントシミュレーション**  
  ```bash
  python src/agent.py
  ```  
  プロンプトに従い、迷路ファイルのパス、意思決定ポイント、スタート／ゴール座標を入力してください。シミュレーション終了後、移動履歴ファイルが生成されます。

- **実験（ゲームプレイ＋リプレイ）**  
  ```bash
  python src/exp/maze_experiment.py [maze_file]
  ```  
  迷路ファイルが指定されなかった場合は、ランダムな迷路が生成されます。プレイ後、自動で最新の移動履歴が選ばれ、リプレイが開始されます。

- **インタラクティブ迷路ゲーム**  
  ```bash
  python src/game.py [maze_file]
  ```  
  キーボード操作（矢印キー）により移動し、全てのセルを探索するとゲームクリアとなり、移動履歴が保存されます。

- **統計解析ツール**  
  - 迷路の道の分布を解析・プロットする場合:
    ```bash
    python src/hist_maze_road.py
    ```
  - 思考時間のヒストグラムおよび累積グラフを描画する場合:
    ```bash
    python src/hist_think_time.py <directory_or_file_path>
    ```

- **シンプルなリプレイ再生**  
  ```bash
  python src/replay.py <maze_file> <replay_file>
  ```

---

## 依存ライブラリ

- **Python 3.x**
- [Pygame](https://www.pygame.org/)  
- [Tkinter](https://docs.python.org/ja/3/library/tkinter.html)（リプレイ時の入力ウィンドウ用）
- NumPy, Matplotlib, tqdm（統計解析・プロット用）
